-
 hosts: all
 become_method: sudo
 become_user: root
 gather_facts: no
###
 pre_tasks:
 - name: Install python
   raw: bash -c "test -e /usr/bin/python || (yum -y install python || (apt-get -qqy update && apt-get -qqy install python))"
 - name: Gathering facts
   setup:

###
 tasks:
###
  - name: Create required directories
    file:
      path: "{{ item }}"
      state: directory
      mode: 0600
    with_items:
      - /var/opt/BESClient
      - /etc/opt/BESClient
      - /tmp/tem.install
###
  - name: Download CentOS/RHEL installable
    get_url:
      url: http://dpev085.innovate.ibm.com/BESAgents/BESAgent-9.5.10.79-rhe6.x86_64.rpm
      dest: /tmp/tem.install/BESAgent-9.5.10.79-rhe6.x86_64.rpm
      mode: 0755
    when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'
###
  - name: Download Ubuntu/Debian installable
    get_url:
      url: http://dpev085.innovate.ibm.com/BESAgents/BESAgent-9.5.10.79-ubuntu10.amd64.deb
      dest: /tmp/tem.install/BESAgent-9.5.10.79-ubuntu10.amd64.deb
      mode: 0755
    when: ansible_distribution == 'Ubuntu' or ansible_distribution == 'Debian'
###
  - name: Download AIX installable
    shell: |
      /usr/bin/wget http://dpev085.innovate.ibm.com/BESAgents/BESAgent-9.5.10.79.ppc64_aix61.pkg
      chmod 755 BESAgent-9.5.10.79.ppc64_aix61.pkg
    args:
      chdir: /tmp/tem.install/
    when: ansible_distribution == 'AIX'
###
  - name: Install BESClient for RHEL or CentOS
    yum:
      name: "/tmp/tem.install/BESAgent-9.5.10.79-rhe6.x86_64.rpm"
      state: present
    when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat'
###
  - name: Install BESClient for Ubuntu
    apt:
      deb: "/tmp/tem.install/BESAgent-9.5.10.79-ubuntu10.amd64.deb"
      state: present
    when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
###
  - name: Install BESClient for AIX
    shell:
      /usr/sbin/installp -acgqYX -d /tmp/tem.install/BESAgent-9.5.10.79.ppc64_aix61.pkg BESClient
    when: ansible_distribution == 'AIX'
###
  - name: Download Configuration files for BESClient
    shell: |
      /usr/bin/wget -O {{ item.dst }} 'http://dpev085.innovate.ibm.com/BESAgents/configfiles/{{ item.src }}'
      chmod 644 {{ item.dst }}
    with_items :
      - {src: 'besclient.config', dst: '/var/opt/BESClient/besclient.config'}
      - {src: 'actionsite.afxm', dst: '/etc/opt/BESClient/actionsite.afxm'}
    when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat' or ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu' or ansible_distribution == 'AIX'
###
  - name: Start and Enable Service Bigfix BESAgent for Linux
    service:
      name: besclient
      enabled: yes
      state: started
    when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat' or ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
###
  - name: Start and Enable Service Bigfix BESAgent for AIX
    shell: /etc/rc.d/rc2.d/SBESClientd start
    when: ansible_distribution == 'AIX'
###
  - name: Sending report to Solr
    shell: |
      curl -X POST -H 'Content-Type: application/json' 'http://sbysolr-poc.innovate.ibm.com/solr/besclient-status/update/json/docs' --data-binary '{ "server": "{{ ansible_fqdn }}", "os": "{{ ansible_distribution }}", "osVersion": "{{ ansible_distribution_version }}", "message": "BESClient Installed", "timestamp": "{{ ansible_date_time.iso8601 }}", "date": "{{ ansible_date_time.date }}", "time": "{{ ansible_date_time.time }}" }'
    when: ansible_distribution == 'CentOS' or ansible_distribution == 'RedHat' or ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'
###
  - name: send mail
    mail:
       subject: BIGFIX_ALERT  System {{ ansible_hostname }}  has been successfully provisioned
       to:
        - rajibul <rajihuda@in.ibm.com>
        - reshma <reshma.prathap@in.ibm.com>
    delegate_to: localhost









